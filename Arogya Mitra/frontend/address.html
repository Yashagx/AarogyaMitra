<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Aarogya Mitra | Address Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f4f8fb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .lang-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .lang-toggle select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
        }

        .card {
            background: #fff;
            width: 100%;
            max-width: 400px;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 16px;
            color: #333;
        }

        label {
            font-size: 13px;
            margin-top: 10px;
            display: block;
            font-weight: 600;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 4px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #0b5ed7;
            box-shadow: 0 0 0 3px rgba(11, 94, 215, 0.1);
        }

        button {
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: #0b5ed7;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #094bb5;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .note {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 12px;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .autocomplete-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: #f0f8ff;
        }

        .validation-message {
            font-size: 12px;
            margin-top: 4px;
            min-height: 16px;
        }

        .validation-message.error {
            color: #dc3545;
        }

        .validation-message.success {
            color: #28a745;
        }

        .loading {
            color: #666;
            font-style: italic;
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #666;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>

<!-- Language Toggle -->
<div class="lang-toggle">
    <select onchange="changeLanguage(this.value)">
        <option value="en">English</option>
        <option value="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
    </select>
</div>

<div class="card">
    <h2 id="heading">Enter Your Current Address</h2>

    <label for="state" id="label-state">State (Current Address)</label>
    <select id="state" required>
        <option value="">Select State</option>
        <option value="Andhra Pradesh">Andhra Pradesh</option>
        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
        <option value="Assam">Assam</option>
        <option value="Bihar">Bihar</option>
        <option value="Chhattisgarh">Chhattisgarh</option>
        <option value="Goa">Goa</option>
        <option value="Gujarat">Gujarat</option>
        <option value="Haryana">Haryana</option>
        <option value="Himachal Pradesh">Himachal Pradesh</option>
        <option value="Jharkhand">Jharkhand</option>
        <option value="Karnataka">Karnataka</option>
        <option value="Kerala">Kerala</option>
        <option value="Madhya Pradesh">Madhya Pradesh</option>
        <option value="Maharashtra">Maharashtra</option>
        <option value="Manipur">Manipur</option>
        <option value="Meghalaya">Meghalaya</option>
        <option value="Mizoram">Mizoram</option>
        <option value="Nagaland">Nagaland</option>
        <option value="Odisha">Odisha</option>
        <option value="Punjab">Punjab</option>
        <option value="Rajasthan">Rajasthan</option>
        <option value="Sikkim">Sikkim</option>
        <option value="Tamil Nadu">Tamil Nadu</option>
        <option value="Telangana">Telangana</option>
        <option value="Tripura">Tripura</option>
        <option value="Uttar Pradesh">Uttar Pradesh</option>
        <option value="Uttarakhand">Uttarakhand</option>
        <option value="West Bengal">West Bengal</option>
    </select>

    <label for="district" id="label-district">District</label>
    <div class="autocomplete-container">
        <input id="district" placeholder="e.g. Kanchipuram" required>
        <div id="district-suggestions" class="autocomplete-suggestions"></div>
    </div>

    <label for="tehsil" id="label-tehsil">Tehsil / Taluk</label>
    <div class="autocomplete-container">
        <input id="tehsil" placeholder="e.g. Sriperumbudur" required>
        <div id="tehsil-suggestions" class="autocomplete-suggestions"></div>
    </div>

    <label for="pincode" id="label-pincode">Pincode</label>
    <input
        id="pincode"
        placeholder="6-digit pincode"
        pattern="[0-9]{6}"
        inputmode="numeric"
        maxlength="6"
        required
    >
    <div id="pincode-validation" class="validation-message"></div>

    <button id="save-btn" onclick="saveAddress()" disabled>
        Save & Continue
    </button>

    <div class="note" id="note">
        This information helps doctors and hospitals serve you better.
    </div>
</div>

<script>
    // Language translations
    const LANGUAGES = {
        en: {
            heading: "Enter Your Current Address",
            label_state: "State (Current Address)",
            label_district: "District",
            label_tehsil: "Tehsil / Taluk",
            label_pincode: "Pincode",
            save_btn: "Save & Continue",
            note: "This information helps doctors and hospitals serve you better.",
            select_state: "Select State"
        },
        hi: {
            heading: "à¤…à¤ªà¤¨à¤¾ à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤ªà¤¤à¤¾ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚",
            label_state: "à¤°à¤¾à¤œà¥à¤¯ (à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤ªà¤¤à¤¾)",
            label_district: "à¤œà¤¿à¤²à¤¾",
            label_tehsil: "à¤¤à¤¹à¤¸à¥€à¤² / à¤¤à¤¾à¤²à¥à¤•",
            label_pincode: "à¤ªà¤¿à¤¨à¤•à¥‹à¤¡",
            save_btn: "à¤¸à¤¹à¥‡à¤œà¥‡à¤‚ à¤”à¤° à¤œà¤¾à¤°à¥€ à¤°à¤–à¥‡à¤‚",
            note: "à¤¯à¤¹ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤¡à¥‰à¤•à¥à¤Ÿà¤°à¥‹à¤‚ à¤”à¤° à¤…à¤¸à¥à¤ªà¤¤à¤¾à¤²à¥‹à¤‚ à¤•à¥‹ à¤†à¤ªà¤•à¥€ à¤¬à¥‡à¤¹à¤¤à¤° à¤¸à¥‡à¤µà¤¾ à¤•à¤°à¤¨à¥‡ à¤®à¥‡à¤‚ à¤®à¤¦à¤¦ à¤•à¤°à¤¤à¥€ à¤¹à¥ˆà¥¤",
            select_state: "à¤°à¤¾à¤œà¥à¤¯ à¤šà¥à¤¨à¥‡à¤‚"
        }
    };

    let currentLang = 'en';

    function changeLanguage(lang) {
        currentLang = lang;
        const t = LANGUAGES[lang];
        
        document.getElementById('heading').textContent = t.heading;
        document.getElementById('label-state').textContent = t.label_state;
        document.getElementById('label-district').textContent = t.label_district;
        document.getElementById('label-tehsil').textContent = t.label_tehsil;
        document.getElementById('label-pincode').textContent = t.label_pincode;
        document.getElementById('save-btn').textContent = t.save_btn;
        document.getElementById('note').textContent = t.note;
        document.querySelector('#state option[value=""]').textContent = t.select_state;
    }

    // Session validation
    const name = sessionStorage.getItem("am_name") || "Test User";
    const mobile = sessionStorage.getItem("am_mobile") || "9999999999";

    // ðŸ”‘ Groq API Key - Fetch from backend
    let GROQ_API_KEY = null;
    let isKeyLoading = false;

    async function getGroqKey() {
        if (GROQ_API_KEY) {
            return GROQ_API_KEY;
        }
        
        if (isKeyLoading) {
            while (isKeyLoading) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            return GROQ_API_KEY;
        }

        try {
            isKeyLoading = true;
            const res = await fetch('/api/groq-key');
            
            if (!res.ok) {
                throw new Error(`Failed to fetch API key: ${res.status}`);
            }
            
            const data = await res.json();
            
            if (!data.key) {
                throw new Error('No API key in response');
            }
            
            GROQ_API_KEY = data.key;
            console.log('API key loaded successfully');
            return GROQ_API_KEY;
        } catch (error) {
            console.error('Error fetching Groq API key:', error);
            return null;
        } finally {
            isKeyLoading = false;
        }
    }

    // Pre-load API key on page load
    getGroqKey().catch(err => {
        console.error('Failed to pre-load API key:', err);
    });

    // Suggestion cache
    const suggestionCache = new Map();

    // Form elements
    const stateSelect = document.getElementById('state');
    const districtInput = document.getElementById('district');
    const tehsilInput = document.getElementById('tehsil');
    const pincodeInput = document.getElementById('pincode');
    const districtSuggestions = document.getElementById('district-suggestions');
    const tehsilSuggestions = document.getElementById('tehsil-suggestions');
    const pincodeValidation = document.getElementById('pincode-validation');
    const saveBtn = document.getElementById('save-btn');

    let districtTimeout, tehsilTimeout;
    let isPincodeValid = false;
    let isPincodeValidated = false;

    // Predefined district data (fallback when API is unavailable)
    const districtData = {
        "Andhra Pradesh": ["Visakhapatnam", "Vijayawada", "Guntur", "Nellore", "Kurnool", "Rajahmundry", "Tirupati", "Kadapa", "Kakinada", "Anantapur", "Vizianagaram", "Eluru", "Ongole", "Nandyal", "Machilipatnam"],
        "Arunachal Pradesh": ["Itanagar", "Naharlagun", "Pasighat", "Tawang", "Ziro", "Bomdila", "Tezu", "Seppa", "Changlang", "Anini"],
        "Assam": ["Guwahati", "Dibrugarh", "Jorhat", "Nagaon", "Tinsukia", "Silchar", "Tezpur", "Bongaigaon", "Dhubri", "Goalpara", "Kamrup", "Cachar", "Barpeta", "Karimganj", "Sivasagar"],
        "Bihar": ["Patna", "Gaya", "Bhagalpur", "Muzaffarpur", "Darbhanga", "Purnia", "Arrah", "Begusarai", "Katihar", "Munger", "Saharsa", "Sasaram", "Hajipur", "Dehri", "Siwan", "Motihari", "Nawada", "Bagaha", "Buxar", "Kishanganj"],
        "Chhattisgarh": ["Raipur", "Bhilai", "Bilaspur", "Korba", "Durg", "Rajnandgaon", "Jagdalpur", "Raigarh", "Ambikapur", "Mahasamund"],
        "Goa": ["Panaji", "Margao", "Vasco da Gama", "Mapusa", "Ponda", "Bicholim", "Curchorem", "Sanquelim", "Quepem", "Canacona"],
        "Gujarat": ["Ahmedabad", "Surat", "Vadodara", "Rajkot", "Bhavnagar", "Jamnagar", "Junagadh", "Gandhinagar", "Anand", "Nadiad", "Mehsana", "Morbi", "Surendranagar", "Bharuch", "Vapi"],
        "Haryana": ["Faridabad", "Gurgaon", "Panipat", "Ambala", "Yamunanagar", "Rohtak", "Hisar", "Karnal", "Sonipat", "Panchkula", "Bhiwani", "Sirsa", "Bahadurgarh", "Jind", "Thanesar"],
        "Himachal Pradesh": ["Shimla", "Dharamshala", "Solan", "Mandi", "Palampur", "Baddi", "Nahan", "Sundernagar", "Chamba", "Una", "Hamirpur", "Bilaspur", "Kullu", "Kangra", "Kinnaur"],
        "Jharkhand": ["Ranchi", "Jamshedpur", "Dhanbad", "Bokaro", "Deoghar", "Hazaribagh", "Giridih", "Ramgarh", "Medininagar", "Chirkunda", "West Singhbhum", "East Singhbhum", "Saraikela Kharsawan", "Dumka", "Pakur"],
        "Karnataka": ["Bangalore", "Mysore", "Mangalore", "Hubli", "Belgaum", "Gulbarga", "Shimoga", "Tumkur", "Bellary", "Bijapur", "Davangere", "Dharwad", "Raichur", "Hassan", "Chitradurga"],
        "Kerala": ["Thiruvananthapuram", "Kochi", "Kozhikode", "Thrissur", "Kollam", "Palakkad", "Alappuzha", "Malappuram", "Kannur", "Kasaragod", "Pathanamthitta", "Kottayam", "Idukki", "Ernakulam", "Wayanad"],
        "Madhya Pradesh": ["Indore", "Bhopal", "Jabalpur", "Gwalior", "Ujjain", "Sagar", "Dewas", "Satna", "Ratlam", "Rewa", "Katni", "Singrauli", "Burhanpur", "Khandwa", "Morena"],
        "Maharashtra": ["Mumbai", "Pune", "Nagpur", "Thane", "Nashik", "Aurangabad", "Solapur", "Amravati", "Kolhapur", "Sangli", "Jalgaon", "Akola", "Latur", "Dhule", "Ahmednagar", "Chandrapur", "Parbhani", "Ratnagiri", "Satara", "Yavatmal"],
        "Manipur": ["Imphal", "Thoubal", "Bishnupur", "Churachandpur", "Senapati", "Ukhrul", "Chandel", "Tamenglong", "Jiribam", "Kakching"],
        "Meghalaya": ["Shillong", "Tura", "Jowai", "Nongstoin", "Williamnagar", "Baghmara", "Nongpoh", "Resubelpara", "Mairang", "Cherrapunji"],
        "Mizoram": ["Aizawl", "Lunglei", "Champhai", "Serchhip", "Kolasib", "Lawngtlai", "Saiha", "Mamit", "Khawzawl", "Saitual"],
        "Nagaland": ["Kohima", "Dimapur", "Mokokchung", "Tuensang", "Wokha", "Zunheboto", "Phek", "Mon", "Longleng", "Kiphire", "Peren"],
        "Odisha": ["Bhubaneswar", "Cuttack", "Rourkela", "Berhampur", "Sambalpur", "Puri", "Balasore", "Bhadrak", "Baripada", "Jeypore", "Angul", "Jharsuguda", "Rayagada", "Koraput", "Kendrapara"],
        "Punjab": ["Ludhiana", "Amritsar", "Jalandhar", "Patiala", "Bathinda", "Mohali", "Hoshiarpur", "Batala", "Pathankot", "Moga", "Abohar", "Malerkotla", "Khanna", "Phagwara", "Muktsar"],
        "Rajasthan": ["Jaipur", "Jodhpur", "Kota", "Bikaner", "Ajmer", "Udaipur", "Bhilwara", "Alwar", "Bharatpur", "Sikar", "Pali", "Tonk", "Kishangarh", "Beawar", "Hanumangarh"],
        "Sikkim": ["Gangtok", "Namchi", "Gyalshing", "Mangan", "Rangpo", "Jorethang", "Singtam", "Ravangla", "Pelling", "Yuksom"],
        "Tamil Nadu": ["Chennai", "Coimbatore", "Madurai", "Tiruchirappalli", "Salem", "Tirunelveli", "Kanchipuram", "Vellore", "Erode", "Thoothukudi", "Thanjavur", "Dindigul", "Tiruppur", "Ranipet", "Nagercoil", "Karur", "Hosur", "Pollachi", "Cuddalore", "Tiruvannamalai"],
        "Telangana": ["Hyderabad", "Warangal", "Nizamabad", "Khammam", "Karimnagar", "Ramagundam", "Mahbubnagar", "Nalgonda", "Adilabad", "Suryapet", "Siddipet", "Miryalaguda", "Jagtial", "Mancherial", "Nirmal"],
        "Tripura": ["Agartala", "Dharmanagar", "Udaipur", "Kailasahar", "Belonia", "Khowai", "Ambassa", "Teliamura", "Sabroom", "Amarpur"],
        "Uttar Pradesh": ["Lucknow", "Kanpur", "Ghaziabad", "Agra", "Varanasi", "Meerut", "Prayagraj", "Bareilly", "Aligarh", "Moradabad", "Saharanpur", "Gorakhpur", "Noida", "Firozabad", "Jhansi", "Muzaffarnagar", "Mathura", "Budaun", "Rampur", "Shahjahanpur"],
        "Uttarakhand": ["Dehradun", "Haridwar", "Roorkee", "Haldwani", "Rudrapur", "Kashipur", "Rishikesh", "Pithoragarh", "Almora", "Nainital", "Tehri", "Chamoli", "Pauri", "Uttarkashi", "Bageshwar"],
        "West Bengal": ["Kolkata", "Howrah", "Durgapur", "Asansol", "Siliguri", "Bardhaman", "Malda", "Baharampur", "Habra", "Kharagpur", "Darjeeling", "Jalpaiguri", "Purulia", "Bankura", "Birbhum", "Murshidabad", "Nadia", "North 24 Parganas", "South 24 Parganas", "Hooghly"]
    };

    // Check form validity
    function checkFormValidity() {
        const state = stateSelect.value.trim();
        const district = districtInput.value.trim();
        const tehsil = tehsilInput.value.trim();
        const pincode = pincodeInput.value.trim();
        
        const isFormFilled = state && district && tehsil && /^[0-9]{6}$/.test(pincode);
        const canSubmit = isFormFilled && isPincodeValidated;
        
        saveBtn.disabled = !canSubmit;
    }

    // Generate suggestions using Groq AI
    async function generateSuggestions(type, state, partial) {
        const cacheKey = `${type}-${state}-${partial.toLowerCase()}`;
        
        if (suggestionCache.has(cacheKey)) {
            return suggestionCache.get(cacheKey);
        }

        // Try predefined data first for instant results
        if (type === 'district' && districtData[state]) {
            const filtered = districtData[state]
                .filter(d => d.toLowerCase().includes(partial.toLowerCase()))
                .slice(0, 5);
            if (filtered.length > 0) {
                suggestionCache.set(cacheKey, filtered);
                return filtered;
            }
        }

        // Try AI suggestions
        try {
            const apiKey = await getGroqKey();
            
            if (!apiKey) {
                console.warn('No API key available - using fallback data only');
                return getFallbackSuggestions(type, state, partial);
            }

            const prompt = type === 'district' 
                ? `List exactly 5 most common districts in ${state}, India that match or contain "${partial}". Return ONLY a valid JSON array of strings. Example: ["District1","District2","District3","District4","District5"]`
                : `List exactly 5 most common tehsils/taluks in ${districtInput.value} district, ${state}, India that match or contain "${partial}". Return ONLY a valid JSON array of strings. Example: ["Tehsil1","Tehsil2","Tehsil3","Tehsil4","Tehsil5"]`;

            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.3-70b-versatile',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.1,
                    max_tokens: 200
                })
            });

            if (!response.ok) {
                console.error('Groq API Error:', response.status);
                return getFallbackSuggestions(type, state, partial);
            }

            const data = await response.json();
            const content = data.choices[0].message.content.trim();
            const jsonMatch = content.match(/\[.*?\]/s);
            
            if (jsonMatch) {
                const suggestions = JSON.parse(jsonMatch[0]);
                suggestionCache.set(cacheKey, suggestions);
                return suggestions;
            }
            
            return getFallbackSuggestions(type, state, partial);
        } catch (error) {
            console.error('Error generating suggestions:', error);
            return getFallbackSuggestions(type, state, partial);
        }
    }

    // Fallback suggestions from predefined data
    function getFallbackSuggestions(type, state, partial) {
        if (type === 'district' && districtData[state]) {
            return districtData[state]
                .filter(d => d.toLowerCase().includes(partial.toLowerCase()))
                .slice(0, 5);
        }
        return [];
    }

    // Show suggestions
    function showSuggestions(suggestions, container, input) {
        container.innerHTML = '';
        if (suggestions.length === 0) {
            container.classList.remove('active');
            return;
        }

        suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = suggestion;
            div.onclick = () => {
                input.value = suggestion;
                container.classList.remove('active');
                
                if (input === districtInput) {
                    tehsilInput.value = '';
                    tehsilInput.focus();
                }
                
                isPincodeValid = false;
                isPincodeValidated = false;
                checkFormValidity();
            };
            container.appendChild(div);
        });

        container.classList.add('active');
    }

    // District autocomplete
    districtInput.addEventListener('input', function() {
        const state = stateSelect.value;
        const partial = this.value.trim();

        clearTimeout(districtTimeout);
        
        isPincodeValid = false;
        isPincodeValidated = false;
        checkFormValidity();
        
        if (!state || partial.length === 0) {
            districtSuggestions.classList.remove('active');
            return;
        }

        districtTimeout = setTimeout(async () => {
            const suggestions = await generateSuggestions('district', state, partial);
            showSuggestions(suggestions, districtSuggestions, districtInput);
        }, 300);
    });

    // Tehsil autocomplete
    tehsilInput.addEventListener('input', function() {
        const state = stateSelect.value;
        const district = districtInput.value.trim();
        const partial = this.value.trim();

        clearTimeout(tehsilTimeout);
        checkFormValidity();
        
        if (!state || !district || partial.length === 0) {
            tehsilSuggestions.classList.remove('active');
            return;
        }

        tehsilTimeout = setTimeout(async () => {
            const suggestions = await generateSuggestions('tehsil', state, partial);
            showSuggestions(suggestions, tehsilSuggestions, tehsilInput);
        }, 300);
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container')) {
            districtSuggestions.classList.remove('active');
            tehsilSuggestions.classList.remove('active');
        }
    });

    // Clear dependent fields when state changes
    stateSelect.addEventListener('change', function() {
        districtInput.value = '';
        tehsilInput.value = '';
        pincodeInput.value = '';
        pincodeValidation.textContent = '';
        pincodeValidation.className = 'validation-message';
        isPincodeValid = false;
        isPincodeValidated = false;
        checkFormValidity();
    });

    // Clear pincode when district changes
    districtInput.addEventListener('change', function() {
        pincodeInput.value = '';
        pincodeValidation.textContent = '';
        pincodeValidation.className = 'validation-message';
        isPincodeValid = false;
        isPincodeValidated = false;
        checkFormValidity();
    });

    // Pincode validation
    pincodeInput.addEventListener('input', async function() {
        const pincode = this.value.trim();
        const state = stateSelect.value;
        const district = districtInput.value.trim();

        isPincodeValidated = false;
        isPincodeValid = false;
        checkFormValidity();

        if (!/^[0-9]{6}$/.test(pincode)) {
            pincodeValidation.textContent = '';
            pincodeValidation.className = 'validation-message';
            return;
        }

        if (!state || !district) {
            pincodeValidation.className = 'validation-message error';
            pincodeValidation.textContent = 'Please select state and district first';
            return;
        }

        pincodeValidation.className = 'validation-message loading';
        pincodeValidation.innerHTML = '<span class="spinner"></span>Validating pincode...';

        try {
            const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
            const data = await response.json();

            if (data[0].Status === 'Success') {
                const postOffices = data[0].PostOffice;
                const matchingOffice = postOffices.find(po => 
                    po.District.toLowerCase() === district.toLowerCase() &&
                    po.State.toLowerCase() === state.toLowerCase()
                );

                isPincodeValidated = true;
                if (matchingOffice) {
                    isPincodeValid = true;
                    pincodeValidation.className = 'validation-message success';
                    pincodeValidation.textContent = `âœ“ Valid pincode for ${district}, ${state}`;
                } else {
                    isPincodeValid = false;
                    pincodeValidation.className = 'validation-message error';
                    const actualDistrict = postOffices[0].District;
                    const actualState = postOffices[0].State;
                    
                    if (actualState !== state) {
                        pincodeValidation.textContent = `âœ— This pincode belongs to ${actualDistrict}, ${actualState}`;
                    } else {
                        pincodeValidation.textContent = `âœ— This pincode belongs to ${actualDistrict}`;
                    }
                }
                checkFormValidity();
            } else {
                isPincodeValidated = true;
                isPincodeValid = false;
                pincodeValidation.className = 'validation-message error';
                pincodeValidation.textContent = 'âœ— Invalid pincode';
                checkFormValidity();
            }
        } catch (error) {
            console.error('Pincode validation error:', error);
            isPincodeValidated = false;
            isPincodeValid = false;
            pincodeValidation.className = 'validation-message error';
            pincodeValidation.textContent = 'âœ— Could not validate pincode';
            checkFormValidity();
        }
    });

    function saveAddress() {
        const state = stateSelect.value.trim();
        const district = districtInput.value.trim();
        const tehsil = tehsilInput.value.trim();
        const pincode = pincodeInput.value.trim();

        if (!state || !district || !tehsil || !/^[0-9]{6}$/.test(pincode)) {
            alert("Please enter a valid state, district, tehsil, and 6-digit pincode.");
            return;
        }

        if (!isPincodeValidated) {
            alert("Please wait for pincode validation to complete.");
            return;
        }

        if (!isPincodeValid) {
            const confirmSave = confirm('The pincode may not match the selected district. Do you want to continue anyway?');
            if (!confirmSave) return;
        }

        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        fetch("/api/user/address", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                name,
                mobile,
                state,
                district,
                tehsil,
                pincode
            })
        })
        .then(res => {
            if (!res.ok) throw new Error();

            sessionStorage.setItem("address_consumed", "true");
            window.location.replace("dashboard.html");
        })
        .catch(() => {
            alert("Failed to save address. Please try again.");
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save & Continue';
        });
    }

    checkFormValidity();
</script>

</body>
</html>