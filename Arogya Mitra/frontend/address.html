<!DOCTYPE html>
<html lang="en">
<!-- Language Manager -->
<script src="js/lang.js"></script>
<head>
    <meta charset="UTF-8">
    <title>Aarogya Mitra | Address Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f4f8fb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .lang-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .card {
            background: #fff;
            width: 100%;
            max-width: 400px;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 16px;
        }

        label {
            font-size: 13px;
            margin-top: 10px;
            display: block;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 4px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        button {
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: #0b5ed7;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        button:hover {
            background: #094bb5;
        }

        .note {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 12px;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .suggestion-item:hover {
            background: #f0f0f0;
        }

        .validation-message {
            font-size: 12px;
            margin-top: 4px;
            min-height: 16px;
        }

        .validation-message.error {
            color: #dc3545;
        }

        .validation-message.success {
            color: #28a745;
        }

        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>

<body>

<!-- ðŸŒ Language Toggle -->
<div class="lang-toggle">
    <select onchange="setLanguage(this.value)">
        <option value="en">English</option>
        <option value="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
    </select>
</div>

<div class="card">
    <h2 data-i18n="enter_address">Enter Your Current Address</h2>

    <label for="state" data-i18n="current_state">State (Current Address)</label>
    <select id="state" required>
        <option value="">Select State</option>
        <option value="Andhra Pradesh">Andhra Pradesh</option>
        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
        <option value="Assam">Assam</option>
        <option value="Bihar">Bihar</option>
        <option value="Chhattisgarh">Chhattisgarh</option>
        <option value="Goa">Goa</option>
        <option value="Gujarat">Gujarat</option>
        <option value="Haryana">Haryana</option>
        <option value="Himachal Pradesh">Himachal Pradesh</option>
        <option value="Jharkhand">Jharkhand</option>
        <option value="Karnataka">Karnataka</option>
        <option value="Kerala">Kerala</option>
        <option value="Madhya Pradesh">Madhya Pradesh</option>
        <option value="Maharashtra">Maharashtra</option>
        <option value="Manipur">Manipur</option>
        <option value="Meghalaya">Meghalaya</option>
        <option value="Mizoram">Mizoram</option>
        <option value="Nagaland">Nagaland</option>
        <option value="Odisha">Odisha</option>
        <option value="Punjab">Punjab</option>
        <option value="Rajasthan">Rajasthan</option>
        <option value="Sikkim">Sikkim</option>
        <option value="Tamil Nadu">Tamil Nadu</option>
        <option value="Telangana">Telangana</option>
        <option value="Tripura">Tripura</option>
        <option value="Uttar Pradesh">Uttar Pradesh</option>
        <option value="Uttarakhand">Uttarakhand</option>
        <option value="West Bengal">West Bengal</option>
    </select>

    <label for="district" data-i18n="district">District</label>
    <div class="autocomplete-container">
        <input
            id="district"
            data-i18n-placeholder="district"
            placeholder="e.g. Kanchipuram"
            required
        >
        <div id="district-suggestions" class="autocomplete-suggestions"></div>
    </div>

    <label for="tehsil" data-i18n="tehsil">Tehsil / Taluk</label>
    <div class="autocomplete-container">
        <input
            id="tehsil"
            data-i18n-placeholder="tehsil"
            placeholder="e.g. Sriperumbudur"
            required
        >
        <div id="tehsil-suggestions" class="autocomplete-suggestions"></div>
    </div>

    <label for="pincode" data-i18n="pincode">Pincode</label>
    <input
        id="pincode"
        data-i18n-placeholder="pincode"
        placeholder="6-digit pincode"
        pattern="[0-9]{6}"
        inputmode="numeric"
        required
    >
    <div id="pincode-validation" class="validation-message"></div>

    <button onclick="saveAddress()" data-i18n="save_continue">
        Save & Continue
    </button>

    <div class="note" data-i18n="address_note">
        This information helps doctors and hospitals serve you better.
    </div>
</div>

<!-- ðŸŒ Language Engine -->
<script src="js/lang.js"></script>

<script>
    // ðŸ”’ Disable browser back-forward cache
    window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
            window.location.replace("index.html");
        }
    });

    const name = sessionStorage.getItem("am_name");
    const mobile = sessionStorage.getItem("am_mobile");
    const verifiedConsumed = sessionStorage.getItem("verified_consumed");
    const addressConsumed = sessionStorage.getItem("address_consumed");

    // ðŸš« Block invalid access
    if (!name || !mobile || verifiedConsumed !== "true" || addressConsumed === "true") {
        alert("This page has expired. Please continue from login.");
        window.location.replace("index.html");
    }

    // ðŸ”‘ Groq API Key
    const GROQ_API_KEY = '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';

    // Autocomplete functionality
    let districtTimeout, tehsilTimeout;
    const stateSelect = document.getElementById('state');
    const districtInput = document.getElementById('district');
    const tehsilInput = document.getElementById('tehsil');
    const pincodeInput = document.getElementById('pincode');
    const districtSuggestions = document.getElementById('district-suggestions');
    const tehsilSuggestions = document.getElementById('tehsil-suggestions');
    const pincodeValidation = document.getElementById('pincode-validation');

    // Generate suggestions using Groq AI
    async function generateSuggestions(type, state, partial) {
        const prompt = type === 'district' 
            ? `List only the top 5 districts in ${state}, India that start with or contain "${partial}". Return ONLY a JSON array of district names, nothing else. Format: ["District1", "District2", ...]`
            : `List only the top 5 tehsils/taluks in ${districtInput.value} district, ${state}, India that start with or contain "${partial}". Return ONLY a JSON array of tehsil names, nothing else. Format: ["Tehsil1", "Tehsil2", ...]`;

        try {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.3-70b-versatile',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.3,
                    max_tokens: 200
                })
            });

            const data = await response.json();
            const content = data.choices[0].message.content.trim();
            
            // Extract JSON array from response
            const jsonMatch = content.match(/\[.*?\]/s);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }
            return [];
        } catch (error) {
            console.error('Error generating suggestions:', error);
            return [];
        }
    }

    // Show suggestions
    function showSuggestions(suggestions, container, input) {
        container.innerHTML = '';
        if (suggestions.length === 0) {
            container.classList.remove('active');
            return;
        }

        suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = suggestion;
            div.onclick = () => {
                input.value = suggestion;
                container.classList.remove('active');
                
                // Trigger tehsil suggestions when district is selected
                if (input === districtInput) {
                    tehsilInput.value = '';
                    tehsilInput.focus();
                }
            };
            container.appendChild(div);
        });

        container.classList.add('active');
    }

    // District autocomplete
    districtInput.addEventListener('input', function() {
        const state = stateSelect.value;
        const partial = this.value.trim();

        clearTimeout(districtTimeout);
        
        if (!state || partial.length < 2) {
            districtSuggestions.classList.remove('active');
            return;
        }

        districtTimeout = setTimeout(async () => {
            const suggestions = await generateSuggestions('district', state, partial);
            showSuggestions(suggestions, districtSuggestions, districtInput);
        }, 500);
    });

    // Tehsil autocomplete
    tehsilInput.addEventListener('input', function() {
        const state = stateSelect.value;
        const district = districtInput.value.trim();
        const partial = this.value.trim();

        clearTimeout(tehsilTimeout);
        
        if (!state || !district || partial.length < 2) {
            tehsilSuggestions.classList.remove('active');
            return;
        }

        tehsilTimeout = setTimeout(async () => {
            const suggestions = await generateSuggestions('tehsil', state, partial);
            showSuggestions(suggestions, tehsilSuggestions, tehsilInput);
        }, 500);
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container')) {
            districtSuggestions.classList.remove('active');
            tehsilSuggestions.classList.remove('active');
        }
    });

    // Clear dependent fields when state changes
    stateSelect.addEventListener('change', function() {
        districtInput.value = '';
        tehsilInput.value = '';
        pincodeInput.value = '';
        pincodeValidation.textContent = '';
        pincodeValidation.className = 'validation-message';
    });

    // Clear pincode and validation when district changes
    districtInput.addEventListener('change', function() {
        pincodeInput.value = '';
        pincodeValidation.textContent = '';
        pincodeValidation.className = 'validation-message';
    });

    // Also trigger on blur (when user clicks away after typing)
    districtInput.addEventListener('blur', function() {
        const currentDistrict = this.value.trim();
        const pincode = pincodeInput.value.trim();
        
        // If there's a pincode and district changed, revalidate
        if (pincode && /^[0-9]{6}$/.test(pincode)) {
            pincodeInput.dispatchEvent(new Event('input'));
        }
    });

    // Pincode validation
    pincodeInput.addEventListener('input', async function() {
        const pincode = this.value.trim();
        const state = stateSelect.value;
        const district = districtInput.value.trim();

        if (!/^[0-9]{6}$/.test(pincode)) {
            pincodeValidation.textContent = '';
            return;
        }

        if (!state || !district) {
            pincodeValidation.className = 'validation-message error';
            pincodeValidation.textContent = 'Please select state and district first';
            return;
        }

        pincodeValidation.className = 'validation-message loading';
        pincodeValidation.textContent = 'Validating pincode...';

        try {
            // First try India Post API
            const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
            const data = await response.json();

            if (data[0].Status === 'Success') {
                const postOffices = data[0].PostOffice;
                const matchingOffice = postOffices.find(po => 
                    po.District.toLowerCase() === district.toLowerCase() &&
                    po.State.toLowerCase() === state.toLowerCase()
                );

                if (matchingOffice) {
                    pincodeValidation.className = 'validation-message success';
                    pincodeValidation.textContent = `âœ“ Valid pincode for ${district}`;
                } else {
                    pincodeValidation.className = 'validation-message error';
                    pincodeValidation.textContent = `âœ— This pincode belongs to ${postOffices[0].District}, not ${district}`;
                }
            } else {
                // Fallback to AI validation
                await validatePincodeWithAI(pincode, state, district);
            }
        } catch (error) {
            // Fallback to AI validation
            await validatePincodeWithAI(pincode, state, district);
        }
    });

    // AI-based pincode validation fallback
    async function validatePincodeWithAI(pincode, state, district) {
        const prompt = `Is pincode ${pincode} valid for ${district} district in ${state}, India? Answer with ONLY "YES" or "NO" followed by the correct district name if NO. Format: "YES" or "NO: CorrectDistrictName"`;

        try {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.3-70b-versatile',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.1,
                    max_tokens: 50
                })
            });

            const data = await response.json();
            const answer = data.choices[0].message.content.trim();

            if (answer.startsWith('YES')) {
                pincodeValidation.className = 'validation-message success';
                pincodeValidation.textContent = `âœ“ Valid pincode for ${district}`;
            } else {
                const correctDistrict = answer.split(':')[1]?.trim() || 'another district';
                pincodeValidation.className = 'validation-message error';
                pincodeValidation.textContent = `âœ— This pincode may belong to ${correctDistrict}`;
            }
        } catch (error) {
            pincodeValidation.className = 'validation-message';
            pincodeValidation.textContent = 'Could not validate pincode';
        }
    }

    function saveAddress() {
        const state = document.getElementById("state").value.trim();
        const district = document.getElementById("district").value.trim();
        const tehsil = document.getElementById("tehsil").value.trim();
        const pincode = document.getElementById("pincode").value.trim();

        if (!state || !district || !tehsil || !/^[0-9]{6}$/.test(pincode)) {
            alert("Please enter a valid state, district, tehsil, and 6-digit pincode.");
            return;
        }

        // Check if pincode validation shows error
        if (pincodeValidation.classList.contains('error')) {
            const confirmSave = confirm('The pincode may not match the selected district. Do you want to continue anyway?');
            if (!confirmSave) return;
        }

        // âœ… Send 'state' (current address state) - this will be used everywhere in the project
        fetch("/api/user/address", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                name,
                mobile,
                state,  // âœ… Current address state
                district,
                tehsil,
                pincode
            })
        })
        .then(res => {
            if (!res.ok) throw new Error();

            // âœ… Mark address page as consumed
            sessionStorage.setItem("address_consumed", "true");

            // âœ… Replace history so back button skips this page
            window.location.replace("dashboard.html");
        })
        .catch(() => {
            alert("Failed to save address. Please try again.");
        });
    }
</script>

</body>
</html>