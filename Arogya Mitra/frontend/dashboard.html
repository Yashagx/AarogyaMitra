<!DOCTYPE html>
<html lang="en">
<script src="js/lang.js"></script>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Aarogya Mitra | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8f4 100%);
            min-height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #0b5ed7 0%, #0056b3 100%);
            padding: 20px 0;
            z-index: 1000;
            transition: transform 0.3s ease;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .sidebar-brand {
            color: white;
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-slogan {
            color: rgba(255,255,255,0.8);
            font-size: 11px;
            margin-top: 5px;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin: 5px 10px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .sidebar-menu i {
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            padding: 0 20px;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #0b5ed7;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }

        /* TOP NAVIGATION BAR */
        .top-nav {
            background: white;
            padding: 16px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-search {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .nav-search input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-search input:focus {
            outline: none;
            border-color: #0b5ed7;
        }

        .nav-search {
            position: relative;
        }

        .nav-search i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .nav-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: #333;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: #f0f0f0;
        }

        .notif-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-profile-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-profile-btn:hover {
            background: #e9ecef;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #0b5ed7;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        /* CONTAINER */
        .container {
            padding: 30px;
        }

        /* PROFILE MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #0b5ed7 0%, #0056b3 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 30px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid #0b5ed7;
            margin: 0 auto 15px;
            display: block;
            object-fit: cover;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .profile-abha {
            color: #0b5ed7;
            font-size: 14px;
            font-weight: 600;
        }

        .profile-section {
            margin-bottom: 25px;
        }

        .profile-section h3 {
            font-size: 16px;
            color: #0b5ed7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .profile-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .profile-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .profile-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        /* STATS CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-icon.blue { background: #e3f2fd; color: #0b5ed7; }
        .stat-icon.green { background: #e7f5ec; color: #198754; }
        .stat-icon.orange { background: #fff3cd; color: #fd7e14; }
        .stat-icon.red { background: #ffe8e8; color: #dc3545; }

        .stat-info h4 {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-info p {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        /* SECTION HEADERS */
        .section-header {
            margin: 32px 0 20px 0;
            color: #333;
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* FEATURE CARDS GRID */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .feature-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #0b5ed7, #198754);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.12);
            border-color: #0b5ed7;
        }

        .feature-card:hover::before {
            transform: scaleX(1);
        }

        .feature-icon {
            font-size: 42px;
            margin-bottom: 12px;
            display: block;
        }

        .feature-card h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .feature-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .feature-card .tag {
            display: inline-block;
            background: #fff3cd;
            color: #856404;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 10px;
        }

        .feature-card.emergency {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
            border-color: #dc3545;
        }

        /* HEALTH SCHEMES TICKER */
        .schemes-ticker {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-top: 30px;
            border-left: 4px solid #0b5ed7;
            min-height: 140px;
        }

        .schemes-ticker h3 {
            color: #0b5ed7;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .schemes-content {
            color: #555;
            font-size: 14px;
            line-height: 1.8;
            min-height: 60px;
            position: relative;
        }

        .scheme-item {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: opacity 0.6s ease-in-out;
        }

        .scheme-item.active {
            opacity: 1;
            position: relative;
        }

        .schemes-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #999;
        }

        .spinner-small {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0b5ed7;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        /* FOOTER */
        footer {
            margin-top: 48px;
            padding: 24px;
            text-align: center;
            color: #666;
            font-size: 13px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        footer strong {
            color: #0b5ed7;
        }

        /* LOADING OVERLAY */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 16px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0b5ed7;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #0b5ed7;
            font-weight: 600;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: block;
            }

            .main-content {
                margin-left: 0;
            }

            .nav-search {
                display: none;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .feature-grid {
                grid-template-columns: 1fr;
            }

            .profile-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<!-- LOADING SCREEN -->
<div class="loading" id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text">Loading your dashboard...</div>
</div>

<!-- SIDEBAR TOGGLE -->
<button class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-brand">
            <i class="fas fa-heartbeat"></i>
            Aarogya Mitra
        </div>
        <div class="sidebar-slogan">Your Digital Health Companion</div>
    </div>
    
    <ul class="sidebar-menu">
        <li><a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="symptom-checker.html"><i class="fas fa-stethoscope"></i> Symptom Checker</a></li>
        <li><a href="aarogyaconnect.html"><i class="fas fa-user-md"></i> Find Doctors</a></li>
        <li><a href="health-records.html"><i class="fas fa-folder-open"></i> Health Records</a></li>
        <li><a href="prescriptions.html"><i class="fas fa-file-prescription"></i> Prescriptions</a></li>
        <li><a href="lab-reports.html"><i class="fas fa-flask"></i> Lab Reports</a></li>
        <li><a href="#" onclick="navigateTo('teleconsult')"><i class="fas fa-video"></i> Teleconsultation</a></li>
        <li><a href="#" onclick="navigateTo('emergency')"><i class="fas fa-ambulance"></i> Emergency</a></li>
        <li><a href="#" onclick="navigateTo('medicine')"><i class="fas fa-pills"></i> Medicine Finder</a></li>
        <li><a href="#" onclick="navigateTo('schemes')"><i class="fas fa-landmark"></i> Govt. Schemes</a></li>
    </ul>
</aside>

<!-- MAIN CONTENT -->
<div class="main-content">
    <!-- TOP NAVIGATION -->
    <nav class="top-nav">
        <div class="nav-search">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search for services, doctors, medicines...">
        </div>
        
        <div class="nav-actions">
            <button class="nav-btn" onclick="showNotifications()" title="Notifications">
                <i class="fas fa-bell"></i>
                <span class="notif-badge">3</span>
            </button>
            
            <div class="user-profile-btn" onclick="openProfileModal()">
                <img src="" alt="Profile" class="user-avatar" id="navAvatar">
                <span class="user-name" id="navUserName">Loading...</span>
            </div>
            
            <button class="nav-btn" onclick="handleLogout()" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </nav>

    <!-- CONTAINER -->
    <div class="container">
        <!-- STATS CARDS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="stat-info">
                    <h4>Health Status</h4>
                    <p id="healthStatus">Good</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h4>Active Prescriptions</h4>
                    <p id="activePrescriptions">0</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-info">
                    <h4>Upcoming Appointments</h4>
                    <p id="upcomingAppointments">
                        <span class="spinner-small" style="width: 16px; height: 16px; border-width: 2px; display: inline-block; vertical-align: middle;"></span>
                    </p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon red">
                    <i class="fas fa-file-medical"></i>
                </div>
                <div class="stat-info">
                    <h4>Lab Reports</h4>
                    <p id="labReports">0</p>
                </div>
            </div>
        </div>

        <!-- PRIMARY FEATURES -->
        <div class="section-header">
            <i class="fas fa-hospital"></i>
            Healthcare Services
        </div>
        <div class="feature-grid">
            <div class="feature-card" onclick="window.location.href='symptom-checker.html'">
                <span class="feature-icon">ü©∫</span>
                <h3>Symptom Checker</h3>
                <p>Report your symptoms and get instant AI-powered health guidance.</p>
            </div>

            <div class="feature-card emergency" onclick="navigateTo('emergency')">
                <span class="feature-icon">üöë</span>
                <h3>Emergency Ambulance</h3>
                <p>One-click ambulance booking with GPS tracking and first-aid instructions.</p>
                <span class="tag">‚ö° URGENT</span>
            </div>

            <div class="feature-card" onclick="window.location.href='aarogyaconnect.html'">
                <span class="feature-icon">üë®‚Äç‚öïÔ∏è</span>
                <h3>Find Doctors</h3>
                <p>Find nearby doctors, specialists, and book appointments easily.</p>
            </div>

            <div class="feature-card" onclick="navigateTo('teleconsult')">
                <span class="feature-icon">üìû</span>
                <h3>Teleconsultation</h3>
                <p>Video consultation with doctors from home. No travel needed.</p>
                <span class="tag">NEW</span>
            </div>

            <div class="feature-card" onclick="navigateTo('medicine')">
                <span class="feature-icon">üíä</span>
                <h3>Medicine Availability</h3>
                <p>Check real-time availability of medicines at nearby pharmacies.</p>
            </div>
        </div>

        <!-- RECORDS & REPORTS -->
        <div class="section-header">
            <i class="fas fa-folder"></i>
            My Health Records
        </div>
        <div class="feature-grid">
            <div class="feature-card" onclick="window.location.href='health-records.html'">
                <span class="feature-icon">üìÇ</span>
                <h3>Health Records</h3>
                <p>Access your complete medical history and reports securely.</p>
            </div>
            
            <div class="feature-card" onclick="window.location.href='prescriptions.html'">
                <span class="feature-icon">üßæ</span>
                <h3>My Prescriptions</h3>
                <p>View all your past and current prescriptions in one place.</p>
            </div>
            
            <div class="feature-card" onclick="window.location.href='lab-reports.html'">
                <span class="feature-icon">üß™</span>
                <h3>Lab Reports</h3>
                <p>Download and share your blood tests, X-rays, and scan reports.</p>
            </div>

            <div class="feature-card" onclick="window.location.href='HealthAnalytics.html'">
                <span class="feature-icon">üìä</span>
                <h3>Health Analytics</h3>
                <p>Visual insights on local disease trends and health statistics.</p>
            </div>
        </div>

        <!-- GOVERNMENT SCHEMES -->
        <div class="section-header">
            <i class="fas fa-landmark"></i>
            Government Health Schemes
        </div>
        <div class="feature-grid">
            <div class="feature-card" onclick="navigateTo('ayushman')">
                <span class="feature-icon">üèõÔ∏è</span>
                <h3>Ayushman Bharat</h3>
                <p>Check your eligibility for PM-JAY and access ‚Çπ5 lakh health coverage.</p>
            </div>

            <div class="feature-card" onclick="navigateTo('schemes')">
                <span class="feature-icon">üìã</span>
                <h3>Health Schemes</h3>
                <p>Information on government health programs, subsidies, and benefits.</p>
            </div>

            <div class="feature-card" onclick="navigateTo('first-aid')">
                <span class="feature-icon">ü©π</span>
                <h3>First Aid Tips</h3>
                <p>Offline-friendly emergency first aid guidance in simple language.</p>
                <span class="tag">OFFLINE</span>
            </div>
        </div>

        <!-- HEALTH SCHEMES TICKER -->
        <div class="schemes-ticker">
            <h3>
                <i class="fas fa-info-circle"></i>
                Government Health Scheme Updates
            </h3>
            <div class="schemes-content" id="schemesContent">
                <div class="schemes-loading">
                    <div class="spinner-small"></div>
                    <span>Loading latest health scheme information...</span>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer>
            <strong>¬© 2025 Aarogya Mitra</strong> ¬∑ Built with care for Rural India<br>
            A Digital India Initiative ¬∑ Powered by ABHA & National Health Authority<br>
            <small style="color: #999; margin-top: 8px; display: block;">
                For support: üìû 1800-XXX-XXXX | üìß support@aarogyamitra.gov.in
            </small>
        </footer>
    </div>
</div>

<!-- PROFILE MODAL -->
<div class="modal" id="profileModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>My Profile</h2>
            <button class="modal-close" onclick="closeProfileModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="profile-header">
                <img src="" alt="Profile" class="profile-avatar" id="profileAvatar">
                <div class="profile-name" id="profileName">Loading...</div>
                <div class="profile-abha" id="profileAbha">ABHA ID: Loading...</div>
            </div>

            <div class="profile-section">
                <h3><i class="fas fa-user"></i> Personal Information</h3>
                <div class="profile-grid">
                    <div class="profile-item">
                        <div class="profile-label">Gender</div>
                        <div class="profile-value" id="profileGender">-</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Age</div>
                        <div class="profile-value" id="profileAge">-</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Date of Birth</div>
                        <div class="profile-value" id="profileDob">-</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Mobile</div>
                        <div class="profile-value" id="profileMobile">-</div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3><i class="fas fa-map-marker-alt"></i> Location Details</h3>
                <div class="profile-grid">
                    <div class="profile-item">
                        <div class="profile-label">State</div>
                        <div class="profile-value" id="profileState">-</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">District</div>
                        <div class="profile-value" id="profileDistrict">-</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Tehsil</div>
                        <div class="profile-value" id="profileTehsil">-</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">PIN Code</div>
                        <div class="profile-value" id="profilePincode">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // GLOBAL VARIABLES
    let userProfile = null;
    let shouldWarnOnNavigation = false;
    let currentSchemeIndex = 0;
    let schemeRotationInterval = null;

    // SESSION MANAGEMENT
    const name = sessionStorage.getItem("am_name");
    const mobile = sessionStorage.getItem("am_mobile");

    if (!name || !mobile) {
        alert("‚ö†Ô∏è Session expired. Please sign up again.");
        window.location.href = "index.html";
    }

    // PROFILE PICTURE SELECTOR
    function selectProfilePicture(gender, age) {
        const prefix = gender === 'Male' ? 'M' : 'F';
        const ages = [35, 40, 45, 50, 55, 60, 70, 80];
        
        // Find closest age match
        let closest = ages.reduce((prev, curr) => {
            return Math.abs(curr - age) < Math.abs(prev - age) ? curr : prev;
        });
        
        // Filter only available images based on gender
        const available = {
            'F': [45, 55, 60, 80],
            'M': [35, 40, 50, 60, 70]
        };
        
        if (!available[prefix].includes(closest)) {
            closest = available[prefix].reduce((prev, curr) => {
                return Math.abs(curr - age) < Math.abs(prev - age) ? curr : prev;
            });
        }
        
        return `Profile Pics/${prefix}${closest}.png`;
    }

    // GET CURRENT DATE INFO
    function getCurrentDateInfo() {
        const now = new Date();
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
        return {
            month: months[now.getMonth()],
            year: now.getFullYear()
        };
    }

    // LOAD USER PROFILE
    window.addEventListener('DOMContentLoaded', () => {
        loadUserProfile();
        
    });

    async function loadUserProfile() {
    try {
        const res = await fetch(
            `/api/abha/profile?name=${encodeURIComponent(name)}&mobile=${mobile}`,
            { credentials: "include" }
        );

        if (!res.ok) throw new Error('Profile fetch failed');

        userProfile = await res.json();

        // Set profile picture
        const profilePic = selectProfilePicture(userProfile.gender, userProfile.age);
        document.getElementById('navAvatar').src = profilePic;
        document.getElementById('profileAvatar').src = profilePic;

        // Set nav name
        document.getElementById('navUserName').textContent =
            userProfile.name.split(' ')[0];

        // üî• LOAD REAL DASHBOARD STATS (IMPORTANT)
        await loadAppointmentStats();

        // Initialize health schemes ticker
        initializeHealthSchemes();

        // Hide loading screen
        document.getElementById('loadingScreen').style.display = 'none';

        // Enable navigation warning
        shouldWarnOnNavigation = true;

    } catch (error) {
        console.error('Profile load error:', error);
        alert("‚ö†Ô∏è Unable to load your profile. Please login again.");
        window.location.href = "index.html";
    }
}


async function loadAppointmentStats() {
    try {
        const healthStatusEl = document.getElementById('healthStatus');
        const activePrescriptionsEl = document.getElementById('activePrescriptions');
        const labReportsEl = document.getElementById('labReports');
        const upcomingEl = document.getElementById('upcomingAppointments');

        // Show temporary loading state
        upcomingEl.innerHTML = `<span class="spinner-small" style="width: 16px; height: 16px; border-width: 2px; display: inline-block; vertical-align: middle;"></span>`;
        activePrescriptionsEl.textContent = '...';
        labReportsEl.textContent = '...';
        healthStatusEl.textContent = '...';

        // ========== 1) UPCOMING APPOINTMENTS (FROM YOUR EXISTING API) ==========
        const apptRes = await fetch('/api/appointments/history', {
            credentials: "include"
        });

        let upcomingCount = 0;

        if (apptRes.ok) {
            const data = await apptRes.json();
            const appointments = data.appointments || [];
            const today = new Date().toISOString().split('T')[0];

            upcomingCount = appointments.filter(a =>
                a.appointment_date >= today &&
                a.status?.toLowerCase() !== 'cancelled'
            ).length;
        }

        // ========== 2) REAL PRESCRIPTIONS (FROM healthRecordsServer.js) ==========
        const presRes = await fetch('/api/prescriptions', {
            credentials: "include"
        });

        let activePrescriptions = 0;

        if (presRes.ok) {
            const prescriptions = await presRes.json(); // <-- DIRECT ARRAY
            activePrescriptions = Array.isArray(prescriptions) ? prescriptions.length : 0;
        }

        // ========== 3) REAL LAB REPORTS (FROM healthRecordsServer.js) ==========
        const labRes = await fetch('/api/lab-reports', {   // ‚úÖ CORRECT ROUTE
            credentials: "include"
        });

        let labReports = 0;

        if (labRes.ok) {
            const reports = await labRes.json(); // <-- DIRECT ARRAY
            labReports = Array.isArray(reports) ? reports.length : 0;
        }

        // ========== 4) HEALTH STATUS (BASED ON REAL DATA) ==========
        let healthStatus = 'Good';

        if (upcomingCount >= 3 || activePrescriptions >= 3 || labReports >= 3) {
            healthStatus = 'Needs Attention';
        } else if (upcomingCount >= 1 || activePrescriptions >= 1 || labReports >= 1) {
            healthStatus = 'Fair';
        }

        // ========== UPDATE UI ==========
        upcomingEl.textContent = upcomingCount;
        activePrescriptionsEl.textContent = activePrescriptions;
        labReportsEl.textContent = labReports;
        healthStatusEl.textContent = healthStatus;

    } catch (error) {
        console.error('Dashboard stats error:', error);

        document.getElementById('healthStatus').textContent = 'Unknown';
        document.getElementById('activePrescriptions').textContent = '0';
        document.getElementById('labReports').textContent = '0';
        document.getElementById('upcomingAppointments').textContent = '0';
    }
}




    // HEALTH SCHEMES TICKER
    function initializeHealthSchemes() {
        const dateInfo = getCurrentDateInfo();
        const userState = userProfile?.state || userProfile?.homeState || 'India';
        
        const schemes = [
            {
                icon: 'fa-heartbeat',
                title: 'Ayushman Bharat PM-JAY',
                text: `India's largest health assurance scheme providing free health coverage up to ‚Çπ5 lakh per family per year for secondary and tertiary care hospitalization. Over 50 crore beneficiaries across India can avail cashless treatment at empaneled hospitals.`
            },
            {
                icon: 'fa-hospital',
                title: 'Pradhan Mantri Jan Arogya Yojana',
                text: `PM-JAY covers hospitalization costs for serious illnesses including cancer care, cardiac procedures, and organ transplants. No restrictions on family size, age, or gender. Check your eligibility using your Ration Card or ABHA number.`
            },
            {
                icon: 'fa-user-md',
                title: `${userState} Health Updates - ${dateInfo.month} ${dateInfo.year}`,
                text: `Free health checkup camps are being organized across ${userState} this month. Avail free screenings for diabetes, hypertension, and other common diseases at your nearest Primary Health Centre (PHC). Contact your local Anganwadi worker for details.`
            },
            {
                icon: 'fa-shield-alt',
                title: 'National Health Protection Scheme',
                text: `The scheme covers pre and post-hospitalization expenses. Beneficiaries can use their ABHA card at any empaneled public or private hospital nationwide. No paperwork required - completely cashless and paperless treatment process.`
            }
        ];

        const container = document.getElementById('schemesContent');
        
        // Clear loading state
        container.innerHTML = '';
        
        // Create scheme elements
        schemes.forEach((scheme, index) => {
            const schemeEl = document.createElement('div');
            schemeEl.className = 'scheme-item';
            if (index === 0) schemeEl.classList.add('active');
            schemeEl.innerHTML = `
                <i class="fas ${scheme.icon}" style="color: #0b5ed7; margin-right: 8px;"></i>
                <strong>${scheme.title}:</strong> ${scheme.text}
            `;
            container.appendChild(schemeEl);
        });

        // Start rotation
        startSchemeRotation(schemes.length);
    }

    function startSchemeRotation(totalSchemes) {
        // Clear any existing interval
        if (schemeRotationInterval) {
            clearInterval(schemeRotationInterval);
        }

        schemeRotationInterval = setInterval(() => {
            const items = document.querySelectorAll('.scheme-item');
            
            // Fade out current
            items[currentSchemeIndex].classList.remove('active');
            
            // Move to next
            currentSchemeIndex = (currentSchemeIndex + 1) % totalSchemes;
            
            // Fade in next
            items[currentSchemeIndex].classList.add('active');
        }, 8000); // Rotate every 8 seconds
    }

    // PROFILE MODAL
    function openProfileModal() {
        if (!userProfile) return;
        
        document.getElementById('profileName').textContent = userProfile.name;
        document.getElementById('profileAbha').textContent = `ABHA ID: ${userProfile.abhaId}`;
        document.getElementById('profileGender').textContent = userProfile.gender || '-';
        document.getElementById('profileAge').textContent = userProfile.age || '-';
        document.getElementById('profileDob').textContent = userProfile.dob || '-';
        document.getElementById('profileMobile').textContent = userProfile.mobile || '-';
        document.getElementById('profileState').textContent = userProfile.state || userProfile.homeState || '-';
        document.getElementById('profileDistrict').textContent = userProfile.address?.district || '-';
        document.getElementById('profileTehsil').textContent = userProfile.address?.tehsil || '-';
        document.getElementById('profilePincode').textContent = userProfile.address?.pincode || '-';
        
        document.getElementById('profileModal').classList.add('active');
    }

    function closeProfileModal() {
        document.getElementById('profileModal').classList.remove('active');
    }

    // Close modal on outside click
    document.getElementById('profileModal').addEventListener('click', (e) => {
        if (e.target.id === 'profileModal') {
            closeProfileModal();
        }
    });

    // NAVIGATION FUNCTIONS
    function navigateTo(feature) {
        alert(`üöÄ Navigating to: ${feature}\n\nThis feature will be available soon!`);
    }

    function showNotifications() {
        alert("üîî Notifications:\n\n1. Your teleconsultation is scheduled for tomorrow\n2. New prescription available\n3. Health checkup reminder");
    }

    // SIDEBAR TOGGLE
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
    }

    // LOGOUT HANDLER
    function handleLogout() {
        const confirmed = confirm("üö™ Are you sure you want to logout?\n\nYou will need to login again to access your dashboard.");
        
        if (confirmed) {
            // Clear rotation interval
            if (schemeRotationInterval) {
                clearInterval(schemeRotationInterval);
            }
            
            sessionStorage.clear();
            
            fetch("/api/logout", { method: "POST" })
                .then(() => {
                    alert("‚úÖ Logged out successfully!");
                    window.location.replace("index.html");
                })
                .catch(() => {
                    window.location.replace("index.html");
                });
        }
    }

    // PREVENT BACK NAVIGATION WITH WARNING
    history.pushState(null, "", location.href);

    window.onpopstate = function () {
        if (!shouldWarnOnNavigation) return;
        
        const confirmLogout = confirm(
            "‚ö†Ô∏è Going back will logout your session.\n\nAre you sure you want to continue?"
        );

        if (confirmLogout) {
            shouldWarnOnNavigation = false;
            handleLogout();
        } else {
            history.pushState(null, "", location.href);
        }
    };

    // CLEANUP ON PAGE UNLOAD
    window.addEventListener('unload', () => {
        if (schemeRotationInterval) {
            clearInterval(schemeRotationInterval);
        }
    });
</script>

</body>
</html>